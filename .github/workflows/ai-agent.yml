name: OpenCode PR Test Generator

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  opencode:
    runs-on: windows-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: OpenCode test generation
        uses: anomalyco/opencode/github@latest
        env:
          OPENAI_API_KEY: ${{ secrets.MY_API_KEY }}
          OPENAI_BASE_URL: https://openrouter.ai/api/v1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          OPENCODE_DISABLE_PR_COMMENTS: true
          OPENCODE_DISABLE_METADATA: true
          OPENCODE_PLAIN_OUTPUT: true

        with:
          model: deepseek/deepseek-coder
          prompt: |
            Generate C unit test files for the changes in this pull request.

            Rules:
            - Output ONLY valid C code
            - Do NOT include markdown
            - Do NOT include explanations
            - Write files into tests/ directory

      - name: Compile and run tests
        shell: powershell
        run: |
          if (!(Test-Path tests)) {
            Write-Host "No tests directory found."
            exit 0
          }

          Write-Host "Running generated tests..."
          gcc -o tests_runner tests/*.c
          .\tests_runner.exe
